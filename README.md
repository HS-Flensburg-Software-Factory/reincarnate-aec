# ReIncarnate Artifact

## Goals of the artifact

This artifact will demonstrate a working compiler (`Section 4`) and reverse
compiler (`Section 5`) for 3D CAD and Mesh.

## Getting started

* Please open the virtual machine image in virtual box.

* Login is automatic, but in case needed, the password is: `icfp2018`.

* The terminal is open at startup. The project repository is already cloned.
  Navigate to the `reincarnate` directory.  All the required packages are
  already installed. A step-by-step guide for getting started is also
  provided in the `README.md` for future reproducibility.

* Type `cd src` from the `reincarnate` directory and then type `make`. This
  will build all the tools.

## Running the tools

### Compiler: cad3 -> mesh3

We provide 5 LambdaCAD programs and a script that compiles them using our
CAD compiler to generate a 3D mesh. We compile the CAD programs to our mesh
format (.mesh3 files) and also the industry standard format, STL (.stl
files).  The `.mesh3` files will be saved in the `aec/mesh3` directory. The
`.stl` files will be saved in the `aec/stl` directory.

* To run the compiler, run the `aec.sh` script as follows: `./scripts/aec.sh
  -c`.

* If you want to view the rendered meshes, we recommend any of the following
  two approaches:

  - using OpenSCAD which is already installed in this VM. Click on the
    OpenSCAD icon on the vertical panel on the left and then click on `New`.
    To view the rendering, type:
    `import("/home/reincarnate/reincarnate/src/aec/stl/example_name.stl");`

  - using the online STL viewer: www.viewstl.com. Note that this website
    only works on STL files. You can upload the stl files generated by our
    compiler and see how they look.

* We already provide screen shots of the renderings in the directory
  `aec/renderings`, where the file names correspond to the CADs.

### Synthesis: mesh3 -> cad3

In order to show the working synthesis tool, we provide the case studies we
showed in the paper (`Section 6`). We also provide some other smaller
examples that are faster than the ones in the paper.

* We recommend first running the script `./scripts/basic.sh` to run the
  synthesis tool on the 5 programs we showed for the compiler.

* To run the case studies in the paper (`Section 6`), run the main aec
  script as follows: `./scripts/aec.sh -s `. We recommend letting this
  script run for a day.

* There are several other relatively fast examples we provide for synthesis
  that you can try to run yourself if you are interested.  You can
  synthesize both from `stl` and `mesh3` formats.

  The command for some `example.mesh3` is:

  ``` ./Main.native --src aec/mesh3/example.mesh3 --tgt example.cad3 --glue
  os-mesh --no-invariants --fuel x ```

  The command for some `example.stl` is:

  ``` ./Main.native --src aec/mesh3/example.stl --tgt example.cad3 --glue
  os-mesh --no-invariants --fuel x ```

  `fuel` is a parameter used by the synthesis algorithm shown in `Figure 18`
  in `Section 5.1` of the paper. It is used to ensure termination of the
  algorithm. All these additional examples will work with `--fuel 10`.

* The synthesized CAD programs will be in files with `.cad3` extensions in
  the `aec/cad3` directory. You can open them to see the results.

* If you want to look at the renderings, we recommend running the script
  `toscad.sh`.  This will pretty print `.scad` files for the `cad3` programs
  our tool synthesized.  You can open these `.scad` files (in the `aec/scad`
  directory) in OpenSCAD and click on the `Render` button to view them.

### Details for further experimentation

As we have explained in `Section 4.2.2` of the paper, the design of our tool
is fully functorial. Some advantages of this design decision is being able
to parametrize our compiler and synthesis tool over different number
systems, and swapping our compiler with other CAD compilers for synthesis
(see `Section 4.2.2`). There are several implementations of number systems
(see `NumSys.ml`, `MPFRNumSys.ml`, `ExactArith.ml`) which are instantiated
in `Main.ml`.  `Glue.ml` contains several configurations (called glues) for
using our compiler or an external compiler (e.g. OpenSCAD) for synthesis.
It is possible to choose the configuration from the command line. Type
`./Main.native -h` to see all the options.

For the compiler experiments, we of course use the compiler that we have
built.  We also check all the invariants (see `Section 3.2.1` of the paper)
to ensure that the meshes our compiler produces are valid.


Currently for the synthesis experiments, we use the OpenSCAD compiler
(indicated by the glue `os-mesh`), and also disable our invariant checks in
order to avoid rounding errors. As we explained in Section `8.1` of the
paper, rounding errors creep in very frequently in CAD compilation and as
part of our future work, we have already started to work on ways to fix it.
Since these numerical issues are still work in progress, for the purpose of
demonstrating our synthesis tool, we leverage the fully functorial design of
our tools and plug in the OpenSCAD compiler.


## CAD compilation and synthesis in Ocaml

### Setup

1. Install system dependencies. On macOS with [Homebrew](https://brew.sh/):
```
  $ brew install coreutils autoconf gnu-time gawk parallel git git-lfs graphviz gnuplot
  $ brew cask install openscad
  $ brew install ocaml opam
```

On Linux without root, using [Linuxbrew](http://linuxbrew.sh/):
```
  $ brew install autoconf parallel git git-lfs graphviz
  $ # ... depending on the Linux distro, install [OpenSCAD](http://www.openscad.org/downloads.html)
  $ # ... build gnuplot from source
  $ brew install ocaml opam
```

On Linux with root and `apt`:
```
  $ apt-get install autoconf parallel git git-lfs graphviz gnuplot openscad
  $ apt-get install ocaml opam
```

2. Install [opam](https://opam.ocaml.org/) packages:
```
  $ opam init
  $ eval `opam config env`
  $ opam install mlgmpidl zarith hashcons menhir js_of_ocaml
```

3. Run GNU parallel once interactively and acknowledge that you will cite the authors:
```
  $ parallel --citation

```
4. Build the compiler and synthesis tool:
```
  $ cd reincarnate/src
  $ make
```
