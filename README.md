# ReIncarnate Artifact

## Goals of the artifact

In our paper, we made the following contributions (`Section 1`, last
paragraph):

1. A purely functional programming language model for 3D CAD along with
   denotational semantics for both CAD and triangular mesh.

2. A meaning preserving compilation algorithm from 3D CAD to mesh along with a
   proof sketch for compiler correctness.

3. A synthesis algorithm that can reverse engineer 3D CAD programs from meshes.

In support of these contributions, this artifact will demonstrate:

* An early prototype of the compiler (`Section 4`) from the core 3D CAD
  language (`Figure 8` in the paper) to mesh.

* An early prototype of the synthesis tool or reverse compiler (`Section 5`)
  from 3D mesh to CAD.

This document contains the following parts:

* Getting started.

* How to run the compiler and synthesis tool.

* How to use the tools for additional experiments.

* How to set up ReIncarnate on a different machine (this is also how we set up
  the VM).

## Getting started

* Please open the virtual machine image in virtual box.

* Login is automatic, but in case needed, the password is: `icfp2018`.

* The terminal should be open at startup. The project repository is already
  cloned.  Navigate to the `reincarnate` directory.  All the required packages
  are already installed.

* Type `cd src` from the `reincarnate` directory and then type `make`. This
  will build all the tools.

## Running the tools

### Compiler: cad3 -> mesh3

We provide 5 CAD programs and a script that compiles them using our CAD
compiler to generate a 3D mesh.  These CAD programs are in the directory:
`aec/cads-to-compile`.  We compile the CAD programs to our mesh format (.mesh3
files) and also the industry standard format, STL (.stl files).  The `.mesh3`
files will be saved in the `aec/compiled-meshes/mesh3` directory. The `.stl`
files will be saved in the `aec/compiled-meshes/stl` directory.

* To run the compiler, run the following from the `src` directory:
  `./scripts/compile.sh`.

* If you want to view the rendered meshes, we recommend the following
  two approaches:

  - using OpenSCAD which is already installed in this VM. Click on the
    OpenSCAD icon on the vertical panel on the left and then click on `New`.
    To view the rendering, type:
    `import("/home/reincarnate/reincarnate/src/aec/compiled-meshes/stl/example_name.stl");`
    Then click on the `Render` button on top and view the rendering!

  - using the online STL viewer: www.viewstl.com. Note that this website
    only works on STL files. You can upload the stl files generated by our
    compiler and see how they look.

### Synthesis: mesh3 -> cad3

In order to show the working synthesis tool, we provide the case studies we
showed in the paper (`Section 6`). We also provide some other smaller
examples that are faster than the ones in the paper.

* We recommend first running the script `./scripts/basic-synth.sh` to run the
  synthesis tool on the 5 programs we showed for the compiler.

* To run the case studies in the paper (`Section 6`), run
  `./scripts/paper-synth.sh`. We recommend letting this script run for over a
  day.

* The synthesized CAD programs will be in the directory `aec/synthed-cads`. Our
  script will generate both `.cad3` files and `.scad` files in dedicated sub
  directories within `aec/synthed-cads`. The `.cad3` files correspond to the
  CAD programs synthesized in our CAD language. The `.scad` files correspond to
  equivalent CAD programs in the OpenSCAD language. We do this so that you can
  use the OpenSCAD GUI to view the rendered CAD programs.  Clicking on the
  files will open them in OpenSCAD from where you can click the `Render` button
  to view the rendering.

* There are several other relatively fast examples we provide for synthesis
  that you can try to run yourself if you are interested. The meshes for these
  are in the `aec/extra-synth` directory.  The command you need to run for
  synthesizing one of these is:

  ```
   ./Main.native --src aec/extra-synth/example-name.mesh3 --tgt synthed-cads/cad3/example-name.cad3 --glue os-mesh --no-invariants --fuel x
  ```

  `fuel` is a parameter used by the synthesis algorithm shown in `Figure 18`
  in `Section 5.1` of the paper. It is used to ensure termination of the
  algorithm. All these additional examples will work with `--fuel 10`.

  You can further experiment to generate the corresponding `scad` files if you
  are curious to see the renderings on OpenSCAD. The command for that is:

  ```
  ./Main.native --src aec/synthed-cads/cad3/example-name.cad3 --tgt aec/synthed-cads/scad/example-name.scad
  ```

### Details for further experimentation

As we have explained in `Section 4.2.2` of the paper, the design of our tool
is fully functorial. Some advantages of this design decision is being able
to parametrize our compiler and synthesis tool over different number
systems, and swapping our compiler with other CAD compilers for synthesis
(see `Section 4.2.2`). There are several implementations of number systems
(see `NumSys.ml`, `MPFRNumSys.ml`, `ExactArith.ml`) which are instantiated
in `Main.ml`.  `Glue.ml` contains several configurations (called glues) for
using our compiler or an external compiler (e.g. OpenSCAD) for synthesis.
It is possible to choose the configuration from the command line. Type
`./Main.native -h` to see all the options.

For the compiler experiments, we of course use the compiler that we have
built.  We also check all the invariants (see `Section 3.2.1` of the paper)
to ensure that the meshes our compiler produces are valid.


Currently for the synthesis experiments, we use the OpenSCAD compiler
(indicated by the glue `os-mesh`), and also disable our invariant checks in
order to avoid rounding errors. As we explained in Section `8.1` of the
paper, rounding errors creep in very frequently in CAD compilation and as
part of our future work, we have already started to work on ways to fix it.
Since these numerical issues are still work in progress, for the purpose of
demonstrating our synthesis tool, we leverage the fully functorial design of
our tools and plug in the OpenSCAD compiler.


### Setup instructions

1. Install system dependencies. On macOS with [Homebrew](https://brew.sh/):
```
  $ brew install coreutils autoconf gnu-time gawk parallel git git-lfs graphviz gnuplot
  $ brew cask install openscad
  $ brew install ocaml opam
```

On Linux without root, you need to install [OpenSCAD](http://www.openscad.org/downloads.html)
and build gnuplot from source. Then using [Linuxbrew](http://linuxbrew.sh/):

```
  $ brew install autoconf parallel git git-lfs graphviz
  $ brew install ocaml opam
```

On Linux with root and `apt`:
```
  $ apt-get install autoconf parallel git git-lfs graphviz gnuplot openscad
  $ apt-get install ocaml opam
```

2. Install [opam](https://opam.ocaml.org/) packages:
```
  $ opam init
  $ eval `opam config env`
  $ opam install mlgmpidl zarith hashcons menhir js_of_ocaml
```

3. Run GNU parallel once interactively and acknowledge that you will cite the authors:
```
  $ parallel --citation

```
4. Build the compiler and synthesis tool:
```
  $ cd reincarnate/src
  $ make
```
